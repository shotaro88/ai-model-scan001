- name: Get Private PyPI URL (debug)
  id: pypi
  shell: bash
  run: |
    cat > get_pypi_url.sh << 'EOF'
    #!/usr/bin/env bash
    set -euo pipefail

    : "${MODEL_SECURITY_CLIENT_ID:?not set}"
    : "${MODEL_SECURITY_CLIENT_SECRET:?not set}"
    : "${TSG_ID:?not set}"

    API_ENDPOINT="${MODEL_SECURITY_API_ENDPOINT:-https://api.sase.paloaltonetworks.com/aims}"
    TOKEN_ENDPOINT="${MODEL_SECURITY_TOKEN_ENDPOINT:-https://auth.apps.paloaltonetworks.com/oauth2/access_token}"

    echo "Token endpoint: $TOKEN_ENDPOINT"
    echo "API endpoint:   $API_ENDPOINT"

    TOKEN_RESPONSE=$(curl -sS -X POST "$TOKEN_ENDPOINT" \
      -H "Content-Type: application/x-www-form-urlencoded" \
      -u "$MODEL_SECURITY_CLIENT_ID:$MODEL_SECURITY_CLIENT_SECRET" \
      -d "grant_type=client_credentials&scope=tsg_id:$TSG_ID")

    SCM_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token // empty')
    if [ -z "$SCM_TOKEN" ]; then
      echo "Failed to get access_token. Full response:"
      echo "$TOKEN_RESPONSE"
      exit 1
    fi
    echo "Got access token (masked)."

    HTTP_CODE=$(curl -sS -o pypi_resp.json -w "%{http_code}" \
      -X GET "$API_ENDPOINT/mgmt/v1/pypi/authenticate" \
      -H "Authorization: Bearer $SCM_TOKEN")

    echo "pypi/authenticate http_code=$HTTP_CODE"

    if [ "$HTTP_CODE" != "200" ]; then
      echo "Response body:"
      cat pypi_resp.json
      exit 1
    fi

    PYPI_URL=$(jq -r '.url // empty' < pypi_resp.json)
    if [ -z "$PYPI_URL" ]; then
      echo "No .url in response:"
      cat pypi_resp.json
      exit 1
    fi

    echo "$PYPI_URL"
    EOF

    chmod +x get_pypi_url.sh
    PYPI_URL="$(./get_pypi_url.sh)"
    echo "pypi_url=$PYPI_URL" >> "$GITHUB_OUTPUT"
